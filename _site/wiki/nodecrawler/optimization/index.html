<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.4.0 -->
<title>Optimization | Datumorphism</title>
<meta name="generator" content="Jekyll v3.7.3" />
<meta property="og:title" content="Optimization" />
<meta name="author" content="Datumorphism Collective" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="The study of the data as a means for information about the world" />
<meta property="og:description" content="The study of the data as a means for information about the world" />
<link rel="canonical" href="http://localhost:4000/wiki/nodecrawler/optimization/" />
<meta property="og:url" content="http://localhost:4000/wiki/nodecrawler/optimization/" />
<meta property="og:site_name" content="Datumorphism" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-09-09T15:10:38-04:00" />
<script type="application/ld+json">
{"description":"The study of the data as a means for information about the world","author":{"@type":"Person","name":"Datumorphism Collective"},"@type":"BlogPosting","url":"http://localhost:4000/wiki/nodecrawler/optimization/","headline":"Optimization","dateModified":"2018-07-19T00:00:00-04:00","datePublished":"2018-09-09T15:10:38-04:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/wiki/nodecrawler/optimization/"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css">
  <link rel="stylesheet" href="/assets/bulma/bulma.css">
  <link rel="stylesheet" href="/assets/bulmawatch/united/bulmaswatch.min.css">
  <link rel="stylesheet" href="/assets/fontawesome/web-fonts-with-css/css/fontawesome-all.min.css">
  <link rel="stylesheet" href="/assets/code/base16-solarized.light.css">


  <link rel="apple-touch-icon" sizes="57x57" href="/assets/favicon/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/assets/favicon/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/assets/favicon/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/assets/favicon/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/assets/favicon/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/assets/favicon/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/assets/favicon/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/assets/favicon/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/assets/favicon/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/assets/favicon/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16.png">
  <link rel="manifest" href="/assets/favicon/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/assets/favicon/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      TeX: { extensions: ["color.js","cancel.js", "AMSmath.js", "AMSsymbols.js"] },
      messageStyle: "none"
   });
  </script>
  <script type="text/x-mathjax-config">
  MathJax.Hub.Register.StartupHook("TeX Jax Ready",function () {
    MathJax.Hub.Insert(MathJax.InputJax.TeX.Definitions.macros,{
      cancel: ["Extension","cancel"]
      });
   });
   </script>
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
        inlineMath: [['$','$'], ['\\(','\\)']]
      }
    });
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      processEscapes: true
    }
  });
</script>
  <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    TeX: {
      Macros: {
        overlr: ['\\overset\\leftrightarrow{\#1}',1],
        overl: ['\\overset\leftarrow{\#1}',1],
        overr: ['\\overset\rightarrow{\#1}',1],
        bra: ['\\left\\langle \#1\\right|',1],
        ket: ['\\left| \#1\\right\\rangle',1],
        braket: ['\\langle \#1 \\mid \#2 \\rangle',2],
        avg: ['\\left< \#1 \\right>',1],
        slashed: ['\\cancel{\#1}',1],
        bold: ['\\boldsymbol{\#1}',1],
        sech: ['\\operatorname{sech}{\#1}',1],
        csch: ['\\operatorname{csch}{\#1}',1]
      }
    }
  });
  </script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML' async></script>


  <!-- <link rel="stylesheet" href="//cdn.jsdelivr.net/chartist.js/latest/chartist.min.css"> --><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Datumorphism" /></head>
<body><header class="site-header" role="banner"><section class="hero is-primary is-medium">
    <!-- Hero head: will stick at the top -->
    <!-- <div class="hero-head"> -->
      <nav class="navbar" role="navigation" aria-label="main navigation">
        <div class="container">
          <div class="navbar-brand">
            <a class="navbar-item has-text-weight-bold" rel="author" href="/">Datumorphism</a>
            <!-- <img src="https://bulma.io/images/bulma-type-white.png" alt="Logo"> -->
            <span class="navbar-burger burger" data-target="navbarMenuHeroA">
            <span></span>
            <span></span>
            <span></span>
            </span>
          </div>
          <div id="navbarMenuHeroA" class="navbar-menu">
            <div class="navbar-end">

              <a class="navbar-item has-text-weight-bold" href="/"><i class="fas fa-home"></i></a>

              
              
              <a class="navbar-item has-text-weight-bold" href="http://localhost:4000/til/" >TIL</a>
              
              
              <a class="navbar-item has-text-weight-bold" href="http://localhost:4000/wiki/" >Wiki</a>
              
              
              <a class="navbar-item has-text-weight-bold" href="http://localhost:4000/reading/" >Reading</a>
              
              
              <a class="navbar-item has-text-weight-bold" href="http://localhost:4000/blog/" >Blog</a>
              

              

               
              
              
              
              
              
              
              
              <a class="navbar-item has-text-weight-bold" href="/about/">About</a>
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              

            </div>
          </div>
        </div>
      </nav>
    <!-- </div> -->
  </section>
  <script>
  document.addEventListener('DOMContentLoaded', function () {

  // Get all "navbar-burger" elements
  var $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);

  // Check if there are any navbar burgers
  if ($navbarBurgers.length > 0) {

    // Add a click event on each of them
    $navbarBurgers.forEach(function ($el) {
      $el.addEventListener('click', function () {

        // Get the target from the "data-target" attribute
        var target = $el.dataset.target;
        var $target = document.getElementById(target);

        // Toggle the class on both the "navbar-burger" and the "navbar-menu"
        $el.classList.toggle('is-active');
        $target.classList.toggle('is-active');

      });
    });
  }

});
  </script>

</header>
<main class="main--content" aria-label="Content">
    <div class="columns">
      <div class="column is-12">
        <div class="content is-medium">
          <article class="post">

  <header class="post-header">
    <h1 class="post-title has-text-centered is-size-1" itemprop="name headline">Optimization</h1>
    <p class="post-meta has-text-centered">
      <time class="dt-published" datetime="2018-09-09T15:10:38-04:00" itemprop="datePublished">Sep 9, 2018
      </time>
       • <span style="font-style: regular;">{</span>
       <span style="padding-right: 0.2em;padding-left: 0.2em;"><a href="http://localhost:4000/wiki/#node-crawler">⸢Node Crawler⸥</a></span>
       
       }
      
      
       • <span style="font-style: regular;">[</span>
       <span style="padding-right: 0.2em;padding-left: 0.2em;"><a href="http://localhost:4000/wiki/?keywords=Node">#Node</a></span>
       
       <span style="padding-right: 0.2em;padding-left: 0.2em;"><a href="http://localhost:4000/wiki/?keywords=Crawler">#Crawler</a></span>
       
       ]
      
      
      <article class="message">
        <div class="message-header">
          <p>Source:</p>
        </div>
        <div class="message-body">
          <ul>
          
            <li><a href="" style="text-decoration:none;">05-微小的优化@ninthakeey</a></li>
          
          </ul>
        </div>
      </article>
      
      
      <div class="notification is-primary">
         The original Chinese article is written by ninthakeey. It has been translated and remixed by Datumorphism
       </div>
      
    </p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>In this article, we will be optimizing the crawler to get better performance.</p>

<h2 id="batch-jobs">Batch Jobs</h2>

<p>In the article about using MongoDB as data storage, we write the data to database whenever we get it. In practice, this is not efficient at all. Here comes the batch jobs. It would be much better if one write to database with batch jobs.</p>

<p>If you recall, the code we used to write to database is</p>
<pre><code class="language-JavaScript">// ...other code
localdb.test.save(data, (err, res)=&gt;{
	// do something
})
</code></pre>
<p>The function <code class="highlighter-rouge">save</code> takes in not only one entry of document but an array of documents:</p>
<pre><code class="language-JavaScript">const array = []
for(let i = INI_ID ; i &lt; MAX_ID; i++){
	// fetch data from website
	const data =  fetchData(i)
    array.push(data)
}
localdb.test.save(array, (err, res)=&gt;{
	// do something
})
</code></pre>
<p>It’s essentially the same code but it helps with the efficiency.</p>

<h2 id="asynchronous-and-synchronous">Asynchronous and Synchronous</h2>

<p>Data scraping can be either asynchronous or synchronous.</p>

<p>Synchronous code is easier to read and debug. However, blocking of one function slows down the whole program.</p>
<pre><code class="language-JavaScript">const main = async (MAX_ID) =&gt; {
    const array = []
    for(let i = 0 ; i &lt; MAX_ID; i++){
        // fetch data from website
        const data = await fetchData(i) //this return a Promise
        array.push(data)
    }
    saveToMongoDB(array);
}
main(1000);
</code></pre>

<p>Asynchronous code solves the blocking problem but introduces complexities. Since it doesn’t stop the code from executing the following functions, each function requires a timeout limit.</p>
<pre><code class="language-JavaScript">const main = async (MAX_ID) =&gt; {
    const array = []
    for(let i = 0 ; i &lt; MAX_ID; i++){
        // fetch data from website
        fetchData(i) // it return a Promise
        	.then(data =&gt; array.push(data))
        await sleep(100) // block thread 100 ms    
    }
    // wait for async threads
    while(array.length &lt; MAX_ID){
        await sleep(100)
    }
    saveToMongoDB(array);
}
main(1000);
</code></pre>

<h2 id="resume-jobs">Resume Jobs</h2>

<p>For large sites, the data scraping time is incredibly long. Failure in power, windows update, or even a tiny unidentified bug in the code could interupt the program. It is crucial to be able to resume the crawler from last termination. Especially when the code is asynchronous, termination of program may lead to broken data.</p>

<p>One of the solutions is to write some synchronous code and record the most recent data id which should be already in database and resume from this if interuptions should occur. The problem is that we have not utilized the full power of Node.js if we insist on synchronous code.</p>

<p>Basically, information about the latest run has to be recorded in order to resume the process. We will write all the data of a batch job to database and secure it.</p>

<p>One of the solutions is to create a database collection in MongoDB, say <code class="highlighter-rouge">package</code>. In this collection, we store two fields, <code class="highlighter-rouge">pid</code> and <code class="highlighter-rouge">status</code>, where <code class="highlighter-rouge">pid</code> is the batch job id and <code class="highlighter-rouge">status</code> is the status of this batch job. For example, we define <code class="highlighter-rouge">0</code>, <code class="highlighter-rouge">1</code>, and <code class="highlighter-rouge">-1</code> of status to be ‘waiting’, ‘finished’, and ‘running’, respectively.</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0: waiting
1: finished
-1: running
</code></pre></div></div>

<p>Here is some useful functions.</p>
<pre><code class="language-JavaScript">// obtain most batch job id of status waiting
const findOneWaitingPackage = async () =&gt; {
    return new Promise((resolve, reject) =&gt;
        localdb.package
            .find({ status: { $lte: 0 } })
            .sort({
                status: -1,
                pid: 1
            })
            .limit(1, (err, doc) =&gt; {
                if (err) reject(err)
                else {
                    updatePackageToRunning(doc[0])
                    resolve(doc[0])
                }
            })
    )
}
// reset package collection in database
// create two fields: status and pid
const resetPackage = async () =&gt; {
    indexMember().catch(err =&gt; console.error(err))
    return new Promise((resolve, reject) =&gt;
        localdb.package.drop(() =&gt; {
            localdb.package.ensureIndex({ status: 1 }, () =&gt; {
                localdb.package.ensureIndex(
                    { pid: 1 },
                    { unique: true },
                    (err, res) =&gt; (err ? reject(err) : resolve(res))
                )
            })
        })
    )
}

// create documents of batch jobs
// package status: 0-waiting, 1-finished，-1-running
const insertPackage = async (start, end) =&gt; {
    const packs = Array(end - start + 1)
        .fill(0)
        .map((v, i) =&gt; {
            return {
                pid: i + start,
                status: 0
            }
        })
    return new Promise((resolve, reject) =&gt;
        localdb.package.insert(
            packs,
            (err, res) =&gt; (err ? reject(err) : resolve(res &amp;&amp; res.length))
        )
    )
}
// update batch job status to running
const updatePackageToRunning = async pid =&gt; {
    if (!pid) return
    return new Promise((resolve, reject) =&gt;
        localdb.package.update(
            { pid },
            { $set: { status: -1 } },
            { multi: false },
            (err, doc) =&gt; (err ? reject(err) : resolve(doc))
        )
    )
}
// update batch job id to finished
const updatePackageToFinished = async pid =&gt; {
    return new Promise((resolve, reject) =&gt;
        localdb.package.update(
            { pid },
            { $set: { status: 1 } },
            { multi: false },
            (err, doc) =&gt; (err ? reject(err) : resolve(doc))
        )
    )
}
</code></pre>

<p>The functions <code class="highlighter-rouge">resetPackage</code> and <code class="highlighter-rouge">insertPackage</code> will be executed on the first run. They will create a collection with all the batch job ids.</p>

<p>The function <code class="highlighter-rouge">findOneWaitingPackage</code> will obtain one of the batch jobs. <code class="highlighter-rouge">updatePackageToRunning</code> will change the status to finished whenever the batch job is done. <code class="highlighter-rouge">findOneWaitingPackage</code> will return the value <code class="highlighter-rouge">null</code> when it can not find any document with status <code class="highlighter-rouge">0</code>, which can be used to end the program.</p>

  </div>

  <a class="u-url" href="/wiki/nodecrawler/optimization/" hidden></a>





<div class="is-clearfix"></div>

<nav class="pagination is-centered" role="navigation" aria-label="pagination">
  <ul class="pagination-list">
    
    



    
    
    <li style="list-style:none;">
      <a class="pagination-link " aria-label="Introduction to Node Crawler Series" aria-current="page" href="/wiki/nodecrawler/node-crawler-introduction/">1</a>
    </li>
<!--
<div class="columns">

<div class="column">

</div>


<div class="column">
  
</div>
 -->







    
    
    <li style="list-style:none;">
      <a class="pagination-link " aria-label="Basic Node Crawler" aria-current="page" href="/wiki/nodecrawler/basic-crawler/">2</a>
    </li>
<!--
<div class="columns">

<div class="column">

</div>


<div class="column">
  
</div>
 -->



    
    
    <li style="list-style:none;">
      <a class="pagination-link " aria-label="Manage Data Using MongoDB" aria-current="page" href="/wiki/nodecrawler/manage-data-using-mongodb/">3</a>
    </li>
<!--
<div class="columns">

<div class="column">

</div>


<div class="column">
  
</div>
 -->



    
        <a class="pagination-previous" href="/wiki/nodecrawler/restrictions/" title="Restrictions of Websites">Previous</a>
    
    
    <li style="list-style:none;">
      <a class="pagination-link " aria-label="Restrictions of Websites" aria-current="page" href="/wiki/nodecrawler/restrictions/">4</a>
    </li>
<!--
<div class="columns">

<div class="column">

</div>


<div class="column">
  
      <strong><a class="post-link" href="/wiki/nodecrawler/restrictions/">Restrictions of Websites</a></strong>
  
</div>
 -->



    
    
    <li style="list-style:none;">
      <a class="pagination-link is-current" aria-label="Optimization" aria-current="page" href="/wiki/nodecrawler/optimization/">5</a>
    </li>
<!--
<div class="columns">

<div class="column">

</div>


<div class="column">
  
</div>
 -->


</ul>
</nav>


</article>

        </div>
      </div>
    </div>
    </main><footer class="footer">
  <data class="u-url" href="/"></data>
  <div class="container">
    <div class="content has-text-centered">
      <p>
        <strong>Datumorphism</strong> by <a>Datumorphism Collective</a>.
       <span class="icon">
         <a href="https://github.com/datumorphism"><i class="fab fa-github"></i></a>
       </span>
       <span class="icon">
      <a href="/feed.xml"><i class="fas fa-rss"></i></a>
       </span>
      </p>

    </div>
  </div>
</footer>
<!-- <script src="//cdn.jsdelivr.net/chartist.js/latest/chartist.min.js"></script>
<script src="/assets/js/home-chart.js"></script> -->

<script src="/assets/js/collapse.js"></script>
</body>

</html>
